<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Budget Tracker</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>Budget Tracker</h1>

  <!-- Budget Section -->
  <div id="budget-section">
    <h2>Budget</h2>
    <table id="budget-table">
      <tr>
        <th>Category</th>
        <th>Monthly Budget</th>
        <th>Weekly Budget</th>
        <th>Actual (Month)</th>
        <th>Actual (Week)</th>
      </tr>
    </table>
  </div>

  <!-- Expenses Section -->
  <div id="expenses-section">
    <h2>Expenses</h2>
    <label for="filter-month">Filter by Month:</label>
    <select id="filter-month"></select>
    <label for="filter-year">Year:</label>
    <select id="filter-year"></select>

    <table id="expenses-table">
      <tr>
        <th>Date</th>
        <th>Category</th>
        <th>Description</th>
        <th>Amount</th>
        <th>Action</th>
      </tr>
    </table>
  </div>

  <!-- Add Expense Section -->
  <div id="add-expense-section">
    <h2>Add Expense</h2>
    <label for="expense-date">Date:</label>
    <input type="date" id="expense-date" />

    <label for="expense-category">Category:</label>
    <select id="expense-category"></select>

    <label for="expense-description">Description:</label>
    <input type="text" id="expense-description" />

    <label for="expense-amount">Amount:</label>
    <input type="number" id="expense-amount" step="0.01" />

    <button id="add-expense-button">Add Expense</button>
  </div>

  <!-- Main JavaScript -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-app.js";
    import { getDatabase, ref, push, onValue, off, remove } from "https://www.gstatic.com/firebasejs/11.3.0/firebase-database.js";

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA6ZFSK7jPIkiEv47yl8q-O1jh8DNvOsiI",
      authDomain: "budget-data-b9bcc.firebaseapp.com",
      databaseURL: "https://budget-data-b9bcc-default-rtdb.firebaseio.com",
      projectId: "budget-data-b9bcc",
      storageBucket: "budget-data-b9bcc.appspot.com",
      messagingSenderId: "798831217373",
      appId: "1:798831217373:web:0d011f497ad3b9ca85a934"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let expensesListener = null; // To manage the Firebase listener

    document.addEventListener("DOMContentLoaded", function () {
      setTimeout(setDefaultDate, 500);
      loadBudget();
      populateFilters(); // Populate month/year dropdowns first

      // Attach event listener for the Add Expense button
      document.getElementById("add-expense-button").addEventListener("click", addExpense);

      // Attach event listeners for filter changes
      document.getElementById("filter-month").addEventListener("change", loadExpenses);
      document.getElementById("filter-year").addEventListener("change", loadExpenses);
    });

    // Auto-populate today's date using ISO format (yyyy-mm-dd)
    function setDefaultDate() {
      let dateInput = document.getElementById("expense-date");
      if (!dateInput) {
        console.error("Date input field not found.");
        return;
      }
      let today = new Date();
      dateInput.value = today.toISOString().slice(0, 10);
    }

    // Format date from "YYYY-MM-DD" to "MM/DD/YYYY"
    function formatDate(isoDate) {
      let [year, month, day] = isoDate.split("-");
      return `${month}/${day}/${year}`;
    }

    // Parse "YYYY-MM-DD" as a local date
    function parseLocalDate(dateString) {
      const [year, month, day] = dateString.split('-').map(Number);
      return new Date(year, month - 1, day);
    }

    function loadBudget() {
      let budgetTable = document.getElementById("budget-table");
      let categoryDropdown = document.getElementById("expense-category");

      if (!budgetTable || !categoryDropdown) {
        console.error("Budget table or category dropdown not found");
        return;
      }

      let budget = [
        { name: "Groceries", monthly: 1200 },
        { name: "Dining Out", monthly: 400 },
        { name: "Entertainment", monthly: 200 },
        { name: "Haircuts", monthly: 52 },
        { name: "Alcohol", monthly: 150 },
        { name: "Weekly Allowance", monthly: 1040 },
        { name: "Miscellaneous", monthly: 0 }
      ];

      budgetTable.innerHTML = `<tr>
                                  <th>Category</th>
                                  <th>Monthly Budget</th>
                                  <th>Weekly Budget</th>
                                  <th>Actual (Month)</th>
                                  <th>Actual (Week)</th>
                               </tr>`;

      let totalMonthly = 0;
      let totalWeekly = 0;

      // Clear category dropdown before populating
      categoryDropdown.innerHTML = "";
      
      budget.forEach(category => {
        let weeklyBudget = (category.monthly * 12 / 52).toFixed(2);
        totalMonthly += category.monthly;
        totalWeekly += parseFloat(weeklyBudget);

        let row = budgetTable.insertRow();
        row.innerHTML = `<td>${category.name}</td>
                         <td>$${category.monthly.toFixed(2)}</td>
                         <td>$${weeklyBudget}</td>
                         <td class="actual-month">$0.00</td>
                         <td class="actual-week">$0.00</td>`;

        let option = document.createElement("option");
        option.value = category.name;
        option.textContent = category.name;
        categoryDropdown.appendChild(option);
      });

      // Insert Total Row at the Bottom
      let totalRow = budgetTable.insertRow();
      totalRow.innerHTML = `<td><strong>Total</strong></td>
                            <td><strong>$${totalMonthly.toFixed(2)}</strong></td>
                            <td><strong>$${totalWeekly.toFixed(2)}</strong></td>
                            <td class="actual-month"><strong>$0.00</strong></td>
                            <td class="actual-week"><strong>$0.00</strong></td>`;
      totalRow.classList.add("total-row");
    }

    // Add a new expense
    function addExpense() {
      let date = document.getElementById("expense-date")?.value;
      let category = document.getElementById("expense-category")?.value;
      let description = document.getElementById("expense-description")?.value.trim();
      let amount = parseFloat(document.getElementById("expense-amount")?.value);

      if (!date || !category || isNaN(amount) || amount <= 0) {
        alert("Please fill out all fields with valid data.");
        return;
      }

      let newExpense = { date, category, description, amount };

      push(ref(db, "expenses"), newExpense)
        .then(() => {
          console.log("Expense added successfully");
          // The live listener will update the UI.
        })
        .catch(error => console.error("Error adding expense:", error));
    }

    // Load expenses and update the budget
    function loadExpenses() {
      let expensesTable = document.getElementById("expenses-table");
      if (!expensesTable) {
        console.error("Expenses table not found");
        return;
      }

      // Clear the table before loading new data (retain header row)
      expensesTable.innerHTML = `<tr>
                                  <th>Date</th>
                                  <th>Category</th>
                                  <th>Description</th>
                                  <th>Amount</th>
                                  <th>Action</th>
                                </tr>`;

      const expensesRef = ref(db, "expenses");

      // Reset budget actuals before recalculating
      resetBudgetActuals();

      // Calculate current week boundaries (Friday as first day)
      let today = new Date();
      today.setHours(0, 0, 0, 0);
      let diff = (today.getDay() - 5 + 7) % 7;
      let startOfWeek = new Date(today);
      startOfWeek.setDate(today.getDate() - diff);
      let endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 7);

      // Detach previous listener if it exists
      if (expensesListener) {
        off(expensesRef, "value", expensesListener);
      }

      // Define and attach the new listener
      expensesListener = function(snapshot) {
        // Re-read filter values for updated filtering
        let selectedMonth = document.getElementById("filter-month")?.value;
        let selectedYear = document.getElementById("filter-year")?.value;

        // Clear table except header row
        expensesTable.innerHTML = `<tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Action</th>
                                  </tr>`;

        snapshot.forEach((childSnapshot) => {
          let expense = childSnapshot.val();
          let expenseDate = parseLocalDate(expense.date);
          let expenseMonth = (expenseDate.getMonth() + 1).toString();
          let expenseYear = expenseDate.getFullYear().toString();

          // If expense matches the selected month/year, add to table and update monthly totals
          if (expenseMonth === selectedMonth && expenseYear === selectedYear) {
            let formattedDate = formatDate(expense.date);
            let row = document.createElement("tr");

            let dateCell = document.createElement("td");
            dateCell.textContent = formattedDate;
            row.appendChild(dateCell);

            let categoryCell = document.createElement("td");
            categoryCell.textContent = expense.category;
            row.appendChild(categoryCell);

            let descCell = document.createElement("td");
            descCell.textContent = expense.description || "—";
            row.appendChild(descCell);

            let amountCell = document.createElement("td");
            amountCell.textContent = `$${expense.amount.toFixed(2)}`;
            row.appendChild(amountCell);

            let actionCell = document.createElement("td");
            let deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.addEventListener("click", function() {
              deleteExpense(childSnapshot.key, expense.category, expense.amount);
            });
            actionCell.appendChild(deleteBtn);
            row.appendChild(actionCell);

            expensesTable.appendChild(row);

            // Update monthly totals for this category
            updateBudgetTotals(expense.category, expense.amount, expenseDate, "month");
          }

          // Independently update weekly totals if within the current week
          if (expenseDate >= startOfWeek && expenseDate < endOfWeek) {
            updateBudgetTotals(expense.category, expense.amount, expenseDate, "week");
          }
        });
        // Update the final total row after processing all expenses
        updateTotalRow();
      };

      onValue(expensesRef, expensesListener);
    }

    // Delete an expense
    function deleteExpense(expenseId, category, amount) {
      if (!expenseId) {
        console.error("Invalid expense ID");
        return;
      }

      remove(ref(db, `expenses/${expenseId}`))
        .then(() => {
          console.log("Expense deleted successfully");
          // The live listener will update the UI.
        })
        .catch(error => console.error("Error deleting expense:", error));
    }

    // Reset all budget actuals to zero before recalculating
    function resetBudgetActuals() {
      let budgetTable = document.getElementById("budget-table");
      let rows = budgetTable.getElementsByTagName("tr");

      for (let i = 1; i < rows.length; i++) {
        rows[i].cells[3].textContent = "$0.00"; // Reset Actual (Month)
        rows[i].cells[4].textContent = "$0.00"; // Reset Actual (Week)
      }
    }

    // Update budget totals for either month or week
    function updateBudgetTotals(category, amount, expenseDate, type) {
      let budgetTable = document.getElementById("budget-table");
      let rows = budgetTable.getElementsByTagName("tr");

      // Loop through budget rows (excluding header and Total row)
      for (let i = 1; i < rows.length - 1; i++) {
        let row = rows[i];
        let rowCategory = row.cells[0].textContent;

        if (rowCategory === category) {
          if (type === "month") {
            let actualMonthCell = row.cells[3];
            let currentMonthTotal = parseFloat(actualMonthCell.textContent.replace("$", "")) || 0;
            let newMonthTotal = currentMonthTotal + amount;
            actualMonthCell.textContent = `$${newMonthTotal.toFixed(2)}`;
            applyBudgetColors(
              actualMonthCell,
              newMonthTotal,
              parseFloat(row.cells[1].textContent.replace("$", ""))
            );
          } else if (type === "week") {
            let actualWeekCell = row.cells[4];
            let currentWeekTotal = parseFloat(actualWeekCell.textContent.replace("$", "")) || 0;
            let newWeekTotal = currentWeekTotal + amount;
            actualWeekCell.textContent = `$${newWeekTotal.toFixed(2)}`;
            applyBudgetColors(
              actualWeekCell,
              newWeekTotal,
              parseFloat(row.cells[2].textContent.replace("$", ""))
            );
          }
        }
      }
    }

    // Recalculate and update the total row for monthly and weekly actuals
    function updateTotalRow() {
      let budgetTable = document.getElementById("budget-table");
      let rows = budgetTable.getElementsByTagName("tr");
      let totalMonthActual = 0;
      let totalWeekActual = 0;

      // Loop through budget rows (excluding header and Total row)
      for (let i = 1; i < rows.length - 1; i++) {
        totalMonthActual += parseFloat(rows[i].cells[3].textContent.replace("$", "")) || 0;
        totalWeekActual += parseFloat(rows[i].cells[4].textContent.replace("$", "")) || 0;
      }

      // Update Total Row
      let totalRow = rows[rows.length - 1];
      totalRow.cells[3].innerHTML = `<strong>$${totalMonthActual.toFixed(2)}</strong>`;
      totalRow.cells[4].innerHTML = `<strong>$${totalWeekActual.toFixed(2)}</strong>`;
    }

    // Apply budget color coding
    function applyBudgetColors(cell, actual, budget) {
      cell.classList.remove("over-budget", "near-budget", "under-budget");

      if (actual > budget) {
        cell.classList.add("over-budget"); // Red
      } else if (actual > budget * 0.75) {
        cell.classList.add("near-budget"); // Yellow
      } else {
        cell.classList.add("under-budget"); // Green
      }
    }

    // Populate filters for selecting month and year
    function populateFilters() {
      let monthSelect = document.getElementById("filter-month");
      let yearSelect = document.getElementById("filter-year");

      if (!monthSelect || !yearSelect) {
        console.error("Dropdowns not found.");
        return;
      }

      let today = new Date();
      let currentMonth = today.getMonth() + 1;
      let currentYear = today.getFullYear();

      let months = [
        "January","February","March","April","May","June",
        "July","August","September","October","November","December"
      ];

      // Populate month dropdown
      monthSelect.innerHTML = months
        .map((month, index) => {
          let isSelected = (index + 1 === currentMonth) ? 'selected' : '';
          return `<option value="${index + 1}" ${isSelected}>${month}</option>`;
        })
        .join("");

      // Populate year dropdown (past 10 years + current year)
      yearSelect.innerHTML = [...Array(11)]
        .map((_, i) => {
          let year = currentYear - i;
          let isSelected = (year === currentYear) ? 'selected' : '';
          return `<option value="${year}" ${isSelected}>${year}</option>`;
        })
        .join("");

      // Load expenses after setting filters
      loadExpenses();
    }
  </script>
</body>
</html>
